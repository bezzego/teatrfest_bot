# Отслеживание UTM меток БЕЗ изменения сайта

## Проблема

Без изменения сайта невозможно напрямую извлечь UTM метки из URL сайта, потому что:
- UTM метки находятся в URL сайта (`https://site.com/?utm_source=yandex`)
- Когда пользователь нажимает кнопку для перехода в бот, нужно как-то передать эти метки
- Без JavaScript на сайте невозможно извлечь UTM метки из URL и передать их в ссылку бота

## Решения БЕЗ изменения сайта

### Вариант 1: Промежуточный сервис (рекомендуется)

Создать промежуточный сервис/API, который будет:
1. Принимать запрос с UTM метками
2. Сохранять их в сессии/БД
3. Перенаправлять на сайт
4. При переходе в бот - передавать сохраненные UTM метки

**Как это работает:**
```
Рекламная ссылка → Промежуточный сервис (сохраняет UTM) → Сайт → Бот (получает UTM)
```

**Пример реализации:**
```python
# Промежуточный сервис (Flask/FastAPI)
@app.route('/redirect')
def redirect_with_utm():
    utm_source = request.args.get('utm_source')
    utm_medium = request.args.get('utm_medium')
    # ... другие UTM параметры
    
    # Сохраняем в сессии или БД с уникальным ID
    session_id = generate_session_id()
    save_utm_to_db(session_id, utm_source, utm_medium, ...)
    
    # Перенаправляем на сайт с session_id в cookie или URL
    return redirect(f'https://site.com/?session_id={session_id}')

# На сайте (минимальное изменение - только ссылка на бота)
# Вместо прямой ссылки на бота используем ссылку на промежуточный сервис
<a href="https://redirect-service.com/bot-link?session_id={session_id}">
    Получить скидку
</a>

# Промежуточный сервис формирует ссылку на бота с UTM
@app.route('/bot-link')
def bot_link():
    session_id = request.args.get('session_id')
    utm_params = get_utm_from_db(session_id)
    
    # Формируем ссылку на бота с UTM метками
    bot_link = generate_bot_link_with_utm(utm_params)
    return redirect(bot_link)
```

### Вариант 2: Использовать параметры в ссылке на бота

Если кнопка на сайте уже ведет на бота, можно попросить администратора сайта добавить UTM метки прямо в ссылку на бота.

**Пример:**
```html
<!-- На сайте кнопка ведет на бота с UTM метками -->
<a href="https://t.me/theatrfest_help_bot?start=ENCODED_PARAMS_WITH_UTM">
    Получить скидку
</a>
```

Где `ENCODED_PARAMS_WITH_UTM` содержит UTM метки, закодированные в base64.

**Плюсы:**
- Минимальное изменение (только ссылка на кнопке)
- Работает сразу

**Минусы:**
- UTM метки должны быть известны заранее
- Не работает для динамических UTM меток из URL сайта

### Вариант 3: Использовать рекламные платформы

Если реклама настроена через Яндекс.Директ или Google Ads, можно использовать их параметры для передачи UTM меток.

**Яндекс.Директ:**
- Используйте параметр `{_ym_uid}` для передачи Яндекс ID
- В настройках рекламы укажите финальную ссылку с UTM метками, которая ведет на бота

**Google Ads:**
- Используйте ValueTrack параметры
- Настройте финальную ссылку с UTM метками

### Вариант 4: Использовать slug с информацией о UTM

Можно создать slug, который будет содержать информацию о UTM метках, но это не очень удобно.

**Пример:**
```
https://t.me/theatrfest_help_bot?start=tyumen1_yandex_cpc
```

Где `tyumen1` - slug проекта, `yandex` - utm_source, `cpc` - utm_medium.

**Плюсы:**
- Не требует изменения сайта
- Работает сразу

**Минусы:**
- Ограниченное количество параметров
- Неудобно для большого количества комбинаций

## Рекомендация

**Лучший вариант без изменения сайта:** Использовать промежуточный сервис (Вариант 1).

Это позволит:
- Полностью отслеживать UTM метки
- Не требовать изменений на основном сайте
- Гибко настраивать передачу параметров

**Минимальное изменение:** Если можно изменить только ссылку на кнопке, используйте Вариант 2 - добавьте UTM метки прямо в ссылку на бота.

